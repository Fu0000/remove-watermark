# 后端数据表规范（v1.0）

## 1. 目标
- 统一数据库设计与迁移规范，保证可维护与可回滚。
- 让 DDL 评审可标准化执行。

## 2. 范围
- 适用于 PostgreSQL + Prisma 模型设计、DDL 审核、迁移发布。
- 对齐 `/Users/codelei/Documents/ai-project/remove-watermark/doc/database-design.md`。

## 3. 规则

### 3.1 命名规范
- 表名：复数 `snake_case`（如 `task_results`）。
- 字段：`snake_case`。
- 主键：业务前缀字符串 ID（如 `tsk_`, `usr_`, `sub_`）。

### 3.2 通用字段规范
- 必备字段：`created_at`, `updated_at`。
- 软删除表增加：`deleted_at`。
- 并发控制建议：`version`（整型）。

### 3.3 约束规范
- 主键、唯一键、外键、检查约束必须显式定义。
- 状态字段必须有 Check 或 Enum 限制。
- 幂等类表必须有去重唯一索引。

### 3.4 索引规范
- 必须为高频查询路径建立索引。
- 组合索引遵循左前缀原则。
- 禁止对低选择性字段滥建索引。

### 3.5 状态与枚举规范
- 状态字面量必须与状态机一致，不得私自扩展。
- 事件状态、Webhook 状态与文档契约保持一致。

### 3.6 迁移规范
- 向前兼容优先，禁止直接破坏字段语义。
- 必须提供回滚方案与数据影响评估。
- 迁移流程：本地验证 -> shared 验证 -> staging 演练 -> prod 执行。

### 3.7 数据生命周期
- 原始素材：默认 7 天。
- 结果素材：默认 30 天。
- 审计日志：默认 180 天。
- 中间产物：必须自动清理。

### 3.8 幂等与一致性
- 使用 `idempotency_keys` 防重复提交。
- 使用 `outbox_events` 保障事务与事件一致。
- 账务扣减必须具备唯一去重索引。

## 4. 模板/示例

### 4.1 新表 DDL 审核模板
| 检查项 | 是否通过 | 说明 |
|---|---|---|
| PK/UK/FK/Check 完整 | 是/否 |  |
| 必备字段齐全 | 是/否 |  |
| 索引覆盖主查询 | 是/否 |  |
| 回滚脚本可执行 | 是/否 |  |
| 生命周期策略明确 | 是/否 |  |

### 4.2 幂等索引示例
```sql
CREATE UNIQUE INDEX uk_idempotency_keys_user_key
ON idempotency_keys(user_id, idem_key);
```

## 5. 验收
- DDL 审核清单可直接用于 code review 与上线评审。
- 迁移流程有演练记录和回滚预案。
- 状态字段与真源文档字面量一致。

## 6. 版本记录
| 版本 | 日期 | 说明 |
|---|---|---|
| v1.0 | 2026-02-19 | 首版后端数据表规范 |
