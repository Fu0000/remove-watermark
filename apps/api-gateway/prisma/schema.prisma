generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Task {
  taskId       String   @id @map("task_id") @db.VarChar(64)
  userId       String   @map("user_id") @db.VarChar(64)
  assetId      String   @map("asset_id") @db.VarChar(64)
  mediaType    String   @map("media_type") @db.VarChar(16)
  taskPolicy   String   @map("task_policy") @db.VarChar(16)
  status       String   @db.VarChar(24)
  progress     Int
  version      Int
  errorCode    String?  @map("error_code") @db.VarChar(16)
  errorMessage String?  @map("error_message")
  resultUrl    String?  @map("result_url")
  createdAt    DateTime @map("created_at")
  updatedAt    DateTime @map("updated_at")

  mask TaskMask?

  @@index([userId, createdAt(sort: Desc)])
  @@map("tasks")
}

model TaskMask {
  taskId       String   @id @map("task_id") @db.VarChar(64)
  maskId       String   @map("mask_id") @db.VarChar(64)
  version      Int
  polygons     Json
  brushStrokes Json     @map("brush_strokes")
  updatedAt    DateTime @map("updated_at")

  task Task @relation(fields: [taskId], references: [taskId], onDelete: Cascade)

  @@map("task_masks")
}

model TaskIdempotencyKey {
  id             String   @id @db.VarChar(64)
  userId         String   @map("user_id") @db.VarChar(64)
  idempotencyKey String   @map("idempotency_key") @db.VarChar(128)
  payloadHash    String   @map("payload_hash")
  taskId         String   @map("task_id") @db.VarChar(64)
  createdAt      DateTime @map("created_at")
  updatedAt      DateTime @map("updated_at")

  @@unique([userId, idempotencyKey])
  @@index([taskId])
  @@map("idempotency_keys")
}

model TaskActionIdempotency {
  id             String   @id @db.VarChar(64)
  userId         String   @map("user_id") @db.VarChar(64)
  idempotencyKey String   @map("idempotency_key") @db.VarChar(128)
  payloadHash    String   @map("payload_hash")
  resultJson     Json     @map("result_json")
  updatedAt      DateTime @map("updated_at")

  @@unique([userId, idempotencyKey])
  @@map("task_action_idempotency")
}

model UsageLedger {
  ledgerId    String   @id @map("ledger_id") @db.VarChar(64)
  userId      String   @map("user_id") @db.VarChar(64)
  taskId      String   @map("task_id") @db.VarChar(64)
  status      String   @db.VarChar(16)
  source      String   @db.VarChar(64)
  consumeUnit Int      @map("consume_unit")
  consumeAt   DateTime @map("consume_at")

  @@index([userId, consumeAt(sort: Desc)])
  @@index([taskId])
  @@unique([userId, taskId, status, source], map: "uk_usage_ledger_task_status_source")
  @@map("usage_ledger")
}

model OutboxEvent {
  eventId       String   @id @map("event_id") @db.VarChar(64)
  eventType     String   @map("event_type") @db.VarChar(64)
  aggregateType String   @map("aggregate_type") @db.VarChar(32)
  aggregateId   String   @map("aggregate_id") @db.VarChar(64)
  status        String   @db.VarChar(16)
  retryCount    Int      @map("retry_count")
  createdAt     DateTime @map("created_at")

  @@index([status, createdAt(sort: Asc)])
  @@index([aggregateType, aggregateId])
  @@map("outbox_events")
}

model Plan {
  planId       String   @id @map("plan_id") @db.VarChar(64)
  name         String   @unique(map: "uk_plans_name") @db.VarChar(64)
  price        Int
  currency     String   @default("CNY") @db.Char(3)
  monthlyQuota Int      @map("monthly_quota")
  features     Json     @map("features_json")
  sortOrder    Int      @default(0) @map("sort_order")
  isActive     Boolean  @default(true) @map("is_active")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @default(now()) @map("updated_at")

  @@index([isActive, sortOrder(sort: Asc)], map: "idx_plans_active_sort")
  @@map("plans")
}

model Subscription {
  subscriptionId String    @id @map("subscription_id") @db.VarChar(64)
  userId         String    @map("user_id") @db.VarChar(64)
  planId         String    @map("plan_id") @db.VarChar(64)
  status         String    @db.VarChar(16)
  channel        String    @db.VarChar(16)
  externalOrderId String?  @unique(map: "uk_subscriptions_external_order_id") @map("external_order_id") @db.VarChar(128)
  startedAt      DateTime? @map("started_at")
  effectiveAt    DateTime? @map("effective_at")
  expireAt       DateTime? @map("expire_at")
  canceledAt     DateTime? @map("canceled_at")
  autoRenew      Boolean   @default(false) @map("auto_renew")
  metaJson       Json?     @map("meta_json")
  createdAt      DateTime  @default(now()) @map("created_at")
  updatedAt      DateTime  @default(now()) @map("updated_at")

  @@index([userId, createdAt(sort: Desc)], map: "idx_subscriptions_user_created_at")
  @@map("subscriptions")
}
